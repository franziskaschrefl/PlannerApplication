
@page "/todo"
@using PlannerApplication_pureBlazor.Components.Layout
@using PlannerCSharp.DataAccessLayer


@rendermode InteractiveServer

<PageTitle>ToDo</PageTitle>

<div class="page">

    <NavMenu @ref=navBar OnDateChange="Reload" />


    <main>

        <AddPopUp @ref=newTaskWindow OnDateChange="Reload" SelectedDate="@date_today">

        </AddPopUp>

        <EditTaskPopUp @ref=editTaskWindow OnDateChange="Reload">

        </EditTaskPopUp>
        
        @if (todos.Count == 0){
            <div class="no-task-design">
                <i class="bi bi-calendar"></i>
                <p>No Task Found for the Selected Day.</p>
            </div>
            
        } else {
            if (findType("office")){
                <div class="office">
                    <h2><i class="bi bi-pc-display"></i> Office</h2>
                    <div class="list-group">
                        @foreach (var todo in todos)
                        {
                            if (todo.Type == "office")
                            {
                                <ToDoItem TaskItem="@todo" SelectedDate="@date_today" editTaskWindow="@editTaskWindow" OnDateChange="Reload" />
                            }
                        }
                    </div>
                </div>
            }
            if (findType("home"))
            {
                <div class="home">
                    <h2><i class="bi bi-house-heart-fill"></i> Home</h2>
                    <div class="list-group">
                        @foreach (var todo in todos)
                        {
                            if (todo.Type == "home")
                            {
                                <ToDoItem TaskItem="@todo" SelectedDate="@date_today" editTaskWindow="@editTaskWindow" OnDateChange="Reload" />
                            }
                        }
                    </div>
                </div>
            }
        }
        
        <div class="container_button">
            <button type="button" class="btn btn-success btn-lg shadow-button" style="border-radius: 100%;" @onclick="@(() =>newTaskWindow.ShowModal())">
                <i class="bi bi-plus-lg" style="font-size: 30px; font-weight: 900;"></i>
            </button>
        </div>
    </main>
</div>


@code {




    private DateOnly date_today;
    private NavMenu navBar;
    private AddPopUp newTaskWindow;
    private EditTaskPopUp editTaskWindow;
    private List<ToDoTask> todos = new List<ToDoTask>();

    private bool findType(string type){
        foreach (var todo in todos){
            if (todo.Type == type){
                return true;
            }
        }
        return false;
    }

    public void Reload()
    {
        todos.Clear();
        date_today = navBar.SelectedDay;
        DatabaseRequest request = new DatabaseRequest($"SELECT * FROM ToDo_Items WHERE username = '{Environment.UserName}' AND enddate >= '{date_today.ToString("yyyy-MM-dd")}' AND begindate <= '{date_today.ToString("yyyy-MM-dd")}' ORDER BY title ASC; ");
        getRelevantToDos(request.PerformQuery());
        StateHasChanged();
    }



    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Reload();
        }
        
        
    }

    private void getRelevantToDos(DatabaseResponse response)
    {

        for (int i = 0; i < response.Rows; i++)
        {
            ToDoTask t = new ToDoTask();
            t.Title = response["title"][i];
            t.EndDate = DateOnly.Parse(response["enddate"][i]);
            t.BeginDate = DateOnly.Parse(response["begindate"][i]);
            t.Type = response["type"][i];
            t.Id = int.Parse(response["id"][i]);
            t.Repeat = response["repeat"][i];
            t.Username = response["username"][i];

            if (repeatToday(t.Repeat, t.BeginDate)){
                todos.Add(t);
            }

		}
    }

    private bool repeatToday(string repeat, DateOnly date)
	{
		if (repeat == "daily")
		{
			return true;
		}
		else if (repeat == "weekly")
		{
			if (date_today.DayOfWeek == date.DayOfWeek)
			{
				return true;
			}
		}
		else if (repeat == "monthly")
		{
			if (date_today.Day == date.Day)
			{
				return true;
			}
		}
		else if (repeat == "yearly")
		{
            if (date_today.Day == date.Day && date_today.Month == date.Month)
			{
				return true;
			}
		} 
        else if (repeat == "never")
        {
            return true;
        }
		return false;
	}

   

    
    
}
